{% extends 'base.html' %}
{% load static %}

{% block title %}Ajout d'un étudiant{% endblock %}

{% block bodyId %}addStudentEducatorPage{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">

<header class="welcome-header">
    <div class="user-info">
        Bienvenue sur IpefaSup, {{ logged_user.first_name }} {{ logged_user.last_name }}
    </div>
    <div class="date-time">
        Nous sommes le {{ current_date_time }}
    </div>
</header>

<h1>Ajouter un Etudiant</h1>
{% if success %}
    <p style="color: green;">Étudiant ajouté avec succès.</p>
{% elif success is not none %}
    <p style="color: red;">Erreur : l'adresse email est déjà utilisée ou les données sont invalides.</p>
{% endif %}
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <p id="studentMailFeedback" style="color: red;"></p>
    <button type="submit">Ajouter</button>
</form>

<br><br>
<a href="{% url 'student_manage' %}">Retour à la gestion des étudiants</a>

<script>
// Corrigé : nom du paramètre
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
const checkStudentMailUrl = "{% url 'check_student_mail' %}";

// Attendre que le DOM soit prêt pour attacher l'événement
document.addEventListener("DOMContentLoaded", function() {
    const emailField = document.getElementById('studentMail');
    const feedbackField = document.getElementById('studentMailFeedback');

    if (emailField) {
        emailField.addEventListener('change', function() {
            const studentMail = this.value;
            fetch(checkStudentMailUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ studentMail: studentMail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    feedbackField.textContent = "Cet email étudiant est déjà utilisé.";
                    emailField.value = ""; // Réinitialiser
                } else {
                    feedbackField.textContent = ""; // Réinitialiser le message
                    console.log("Adresse email disponible");
                }
            })
            .catch(error => {
                console.log('Erreur:', error);
                feedbackField.textContent = "Une erreur est survenue lors de la vérification.";
            });
        });
    }
});
</script>
{% endblock %}
